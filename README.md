# 🖨️ CloudChef Print Server

WebSocket сервер для маршрутизации команд печати между веб-приложением CloudChef и агентами принтера.

## 🚀 Быстрый старт

### 1. Деплой на Vercel

```bash
# Клонируйте проект
cd cloudchef-print-server

# Установите Vercel CLI
npm install -g vercel

# Деплой
vercel --prod
```

### 2. Получите URL сервера

После деплоя получите URL вида: `https://cloudchef-print-server.vercel.app`

### 3. Настройте веб-приложение

В веб-приложении используйте этот URL для подключения:

```javascript
const socket = io('https://cloudchef-print-server.vercel.app');

// Регистрация браузера
socket.emit('register_browser', {
  code: '123456', // 6-значный код
  userInfo: {
    email: 'user@example.com',
    restaurant: 'My Restaurant'
  }
});

// Отправка команды печати
socket.emit('print_command', {
  jobId: 'label_001',
  labelData: {
    name: 'Куриное филе',
    expiry: '2024-01-15',
    chef: 'Алексей',
    category: 'Мясо'
  },
  settings: {
    copies: 1,
    priority: 'normal'
  }
});
```

## 🔌 События WebSocket

### Браузер → Сервер

- `register_browser` - Регистрация веб-браузера
- `print_command` - Команда печати этикетки

### Сервер → Браузер  

- `registered` - Подтверждение регистрации
- `agent_connected` - Агент подключился
- `agent_disconnected` - Агент отключился
- `print_sent` - Команда отправлена агенту
- `print_result` - Результат печати

### Агент → Сервер

- `register_agent` - Регистрация агента принтера
- `print_result` - Результат печати
- `agent_heartbeat` - Keep-alive сигнал

### Сервер → Агент

- `registered` - Подтверждение регистрации  
- `print_job` - Задание на печать

## 📊 Система кодов

- **6-значный код** генерируется в веб-приложении
- **Постоянное действие** до создания нового кода
- **Автоматическое сопряжение** браузера и агента по коду
- **Статусы подключения** в реальном времени

## 🛡️ Безопасность

- CORS настроен для всех источников (можно ограничить в продакшене)
- Код сопряжения - единственная авторизация  
- Логирование всех действий
- Автоматическая очистка отключенных соединений

## 📈 Мониторинг

Сервер логирует:
- Подключения/отключения
- Команды печати  
- Ошибки
- Статистику каждые 30 секунд

## 🔧 Разработка

### Локальная разработка

```bash
# Установите зависимости
npm install

# Запустите локально
vercel dev
```

### Тестирование

Откройте `test.html` в браузере для тестирования подключения.

## 🌐 Архитектура

```
┌─────────────────┐    WebSocket    ┌─────────────────┐
│  Web App        │ ←──────────────→ │  Vercel Server  │
│  (Browser)      │     Socket.io    │  (Node.js)      │
└─────────────────┘                  └─────────────────┘
                                             ↕
                                       WebSocket
                                       Socket.io
                                     ┌─────────────────┐
                                     │  Print Agent    │
                                     │  (Electron)     │
                                     └─────────────────┘
```

## 📦 Зависимости

- `socket.io` - WebSocket коммуникация
- `@vercel/node` - Vercel Serverless Functions
- `cors` - Cross-Origin Resource Sharing

## 🚨 Лимиты Vercel

- **Максимальное время выполнения:** 30 секунд (настроено)
- **WebSocket:** Поддерживается через Socket.io
- **Memory:** 1024 MB
- **Concurrent connections:** До 1000 одновременных подключений

## 🆘 Поддержка

При возникновении проблем проверьте:
1. URL сервера корректный
2. Код сопряжения правильный (6 цифр)
3. Консоль браузера на предмет ошибок WebSocket
4. Логи Vercel Functions
